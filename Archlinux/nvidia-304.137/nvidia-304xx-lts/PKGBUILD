# Based on the file created for Arch Linux by:
# Maintainer : Thomas Baechler <thomas@archlinux.org>

# Maintainer: Philip MÃ¼ller <philm@manjaro.org>
# Maintainer: Roland Singer <roland@manjaro.org>

#_linuxprefix=linux-lts
_extramodules="$(uname -r)"
pkgname=nvidia-304xx-dkms
#_pkgname=nvidia
_pkgver=304.137
pkgver=304.137
pkgrel=22
pkgdesc="NVIDIA drivers for linux-lts 6.12.xxx, DKMS version."
arch=('i686' 'x86_64')
url="http://www.nvidia.com/"
depends=('dkms')
provides=('nvidia' 'nvidia-304xx' 'nvidia-304xx-dkms')
conflicts=('nvidia-lts-304xx' 'nvidia' 'nvidia-lts' 'nvidia-dkms' 'nvidia-open' 'nvidia-open-lts' 'nvidia-open-dkms')
license=('custom')
install=nvidia.install
options=(!strip)
source=('0001-disable-mtrr-4.3.patch' '0002-pud-offset-4.12.patch' '0003-nvidia-drm-pci-init-4.14.patch'
'0004-timer-4.15.patch' '0005-usercopy-4.16.patch' '0006-do_gettimeofday-5.0.patch' '0007-subdirs-5.3.patch'
'0008-on-each-cpu-5.3.patch' '0009-remove-drmp-5.5.patch' '0010-proc-ops-5.6.patch'
'0011-kernel-5.7.0-setmemoryarray.patch' '0012-kernel5.8.patch' '0013-kernel5.9.patch'
'0014-import-drm_legacy_pci_init-exit-from-src-linux-5.9.1.patch'
'0015-add-static-and-nv_-prefix-to-copied-drm-legacy-bits.patch'
'0016-fix-mistake.patch' '0016-vmalloc5.9.patch'
'0017-patch-14-kernel-5.11.patch' '0018-kernel5.14.patch' '0019-kernel-5.16.patch'
'0020-kernel-5.17.patch' '0021-kernel-5.18.patch' '0022-kernel-6.0.patch' '0023-kernel-6.2.patch' '0024-kernel-6.3.patch'
'0025-kernel-6.5.patch' '0026-gcc14-fix.patch' '0027-failfast.patch' '0028-gcc15-fix.patch')
source_x86_64=("http://us.download.nvidia.com/XFree86/Linux-x86_64/${_pkgver}/NVIDIA-Linux-x86_64-${_pkgver}-no-compat32.run")
sha512sums=('4165daf24d44f6745e72fe7112d3f5b7b970464c7fedee398b0d8aa4e87e36aafe9edbb50ee7771fef5cd3b9fe3d0ca43b36e0de015bb596c8ed8bdacccf23ec'
            '9ecbf62a96282803bbb66dc23e0976f8f976fa59a3862b7fb64c05de1eb70f3945be7c1670c5916c7317311b74edf49b638c23e589e362d7f76e66401ae8c502'
            '4b7cd18001fc7426d971047fe05392c54cffbf60840dd28f99512072a1099da4d17ba2ec583285c8db44174463c0f7b98ecbbb5c6fd50336ca00daf45e5cb13b'
            '1bc73955677bc3ee2a629b0d8b023bec0c470fb0c01efbd844748d98635772a0ae9c69e4f97de41e06906ea1472cb6714a32e8939bf0843afd2d74257bade16d'
            'faddadeb291f3a59dc9504d8ff95a4f497b8e207281d8f63b1a1aea46a6ffebb049348e034b4d2d80b7db38c2f89481817931c82232bdffc40387618a0c17255'
            'ae23643605de2b12e2d6a4a51ee966fa90f20fe1f6683ef0c5211a4e27eca6def751e015e883cd2ed1324a45f2183a595910cc9b6641c0b04daf253a9550e4b2'
            '3692cb89139d2c221f8587174fb4021015c468657ef14860aec7c0a86f63ff52784d736a8655d5ea937088921631d1738c914cdedb46c1b11201f15bb3b2d4cd'
            '0276a4b14a7eb752d6e5221878b4f5127ef4ad430a7d56b6ec1238d78e1450040675aad679cf2e11d1900a8f7130ee201ba146e35017f27b4897995ee7d8b913'
            '41296ecf5b73ae848abe24f12eefc982c93e051349405d2fd92e05164b5d5535c8f6bf3549aaa89d72c0dee9f9873540a93344e506666a03c9280679b9922fae'
            '838a6f3a7ff8fc4b011dcdabaab84a9f6f30df78b9c4a4ecefe059a2ec0875559e7e911253cecbe1f31a8d7d355034d97863f39ef8f590d032b64853fa63cd9b'
            '54606281bc147050f30d562d14ad92c40c6f9e5205be4c07335d2fc7bd34a41959c10bbc32281b3dfb9b282041f2cd883396808b647a35cd3fea665ba41e678d'
            '047acb54e72faa3fb8c334d83088eb4cf7a821011bfe89ae3a0c1918731c6f163bb20ef915c4630a3a7df9e255ec5c02729aaede96bb708c0d9b1b9f049019da'
            'dd57211ccd01bb45c0e4e7967b58b1259c37da8d9c8b56f3447d07c766becba734c8b40ba648504e56bfe5b4126c45ead8d1c785469e6c5dc30d2121203ee20a'
            '33a203b56fb28b0df24356a44089f34b63c55efa72a5be6d1883404c0aa458024cde5b86e5592117d13250b42692c51f5047cf19e5b1ed5125d9e1c28b545c71'
            'c4b3450361d77224d59eccea51f48751affc736304203b49eb268de4e4969b7e0eac9f317fc379271b4fc7a2b897ace500b2b4f803636c54c99420569717f997'
            'ca4a5e79620e637cd74bbac69a8b2c1fc61124b9bf48ef49f4270111e03b67fa078166f16b3090d905bbc89a05730bb1d69bbdf3941363efe758fd2fee69e057'
            '51a105de3332d827555f7ff2e9d14b4af2ff3a63567a87c98bdf63a4a08b4d29dbabe49f90e56c2d0d1c0afd3c889033a94aff7ba71d37a796385789ee24f295'
            '4424ea297dce5eb3ea809d4370ab57ce9023e2dc5a8666fb20af90e9c9d619d7bbf5ac038cce2f68b69d4a2e4b35a39e8a89a95778a21d958895655f8ec82f5e'
            'd4e7e3717fe98c4a9cbe5a8ce8d844b4a6ce2c6e6816f5cd9116e7501a1d7f2a9d18e0ebdaac6ab09c1c54e9247ec6f54f05447e16528b453a54ee4ad92ac515'
            '7d828562a2ea503d01aa97ccb0f33f50c2b286b3be812349e70a4ac78e192ec44b84456ef40d798d64dea863d865474767f8413c61abe0910072e6b1bbcd27ae'
            '0922a17da09fa6c543756e7fbec18746ca74177b191c8d1f9b4bec9cdb9d878b1c1b1a65b12d85bba536961190abcb3fe47cf693a8be93dc988057ed89de5217'
            'f50d9a32f1e42e8f707712c92db577ae3cefa98baf75856be335fa53cae43d5980dda304e841881fa6f20c0a341bc2a1e421d12b3a20ee96c20454feb3defe84'
            'f7f48b7d69205601520788115cad8e14c948e5d76ab60fe4545bb99e913187aa9a000c347b150a595194d67b2b77f675b1f80c59c293ba3813fddccd2352918a'
            '8a9752f4ac31a8949df859e522d0c37fd24e486a3c22992d5d45c68572b556f586316e8c1e2e7106b6ef4f6615468961fd8fe9a3bd5aa6def8a12f50bb53f51f'
            'b706ccc9e8fee46bde1dbd92f6fb1ac3de6312e5052dddec3cb8bac8a440acf7422b3576a143218143edaf7b9bae017f3ec58602e1ac7a38644979db4aff7294'
            '81744452db8d28e27354150a47afb93a6581de5274aaf26a617ab598490aeddc56e77b45d87a530c58c5ebeddd10a7219ce6faefe5c2585296cb6faf40824e6b'
            'afcfda659f986acd63892bb35c04008be25d9e865b45022584a5bc73dde5bd40e02d23f75fdc0eedd444941089c597e41bc003c182f3b3dcc2ea241474e26b17'
            '837a835b4db95d7f6b9dbf48b9f001385051ad08dbde3ba1a3993f7ee65a5b97499156b5b127615a52b9074799780dc1fa9d8f1b381d12f4950038919a105eab'
            'a32f56d1b94a1100d9b6502101772f04da17fee2297ce6260f3d914fd45cece8c9a8639c8d6e1db2e15aab1a4418161f976ea5e36e167f8a7de9c77a4c08ee0b')
sha512sums_x86_64=('4ab648647e4f3e2c352b2eab6454c264fe4728d8eb1264fafee2a4ab1a4ce59516abcf8490044d31e35309ea951e564cc217e13f7139a48bbf650a4238c5b87c')

#pkgver() {
#    _ver=$(pacman -Q $_linuxprefix | cut -d " " -f 2)
#    printf '%s' "${_pkgver}_${_ver/-/_}"
#}

#[[ "$CARCH" = "i686" ]] && _pkg="NVIDIA-Linux-x86-${_pkgver}"
[[ "$CARCH" = "x86_64" ]] && _pkg="NVIDIA-Linux-x86_64-${_pkgver}-no-compat32"

prepare() {
  cd "$srcdir"
  rm -rf "$_pkg"
  sh "$_pkg.run" --extract-only
  cd "${_pkg}"

  # patches here
  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src = 0*.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 < "../$src"
  done

  #"If you are using a Linux 2.4 kernel, please make sure";
  #"you either have configured kernel sources matching your";
  #"kernel or the correct set of kernel headers installed";
  #"on your system.";

  #"If you are using a Linux 2.6 kernel, please make sure";
  #"you have configured kernel sources matching your kernel";
  #"installed on your system. If you specified a separate";
  #"output directory using either the \"KBUILD_OUTPUT\" or";
  #"the \"O\" KBUILD parameter, make sure to specify this";
  #"directory with the SYSOUT environment variable or with";
  #"the equivalent nvidia-installer command line option.";

  #"Depending on where and how the kernel sources (or the";
  #"kernel headers) were installed, you may need to specify";
  #"their location with the SYSSRC environment variable or";
  #"the equivalent nvidia-installer command line option.";

  #"*** Unable to determine the target kernel version. ***";
  rm kernel/makefile
  rm kernel/Makefile.nvidia
  mv kernel/Makefile.kbuild kernel/Makefile

  cp -a kernel kernel-dkms
}

#build() {
#    _kernver="$(uname -r)"
#
#    cd "${_pkg}/kernel"
#    make SYSSRC=/usr/lib/modules/"${_kernver}/build" module
#}

package() {
    depends=("dkms")

    cd "${_pkg}"
    install -dm 755 "${pkgdir}"/usr/src
    cp -dr --no-preserve='ownership' kernel-dkms "${pkgdir}/usr/src/nvidia-${_pkgver}"

#    install -D -m644 "${srcdir}/${_pkg}/kernel/nvidia.ko" \
#        "${pkgdir}/usr/lib/modules/${_extramodules}/extramodules/nvidia.ko"
#    gzip "${pkgdir}/usr/lib/modules/${_extramodules}/extramodules/nvidia.ko"
}
